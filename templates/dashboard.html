{% extends "base.html" %}

{% block title %}{{ db_info.name }} Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>{{ db_info.icon }} {{ db_info.name }}</h2>
        <p class="text-muted">{{ db_info.description }}</p>
        <a href="/" class="btn btn-sm btn-outline-secondary">â† ëŒì•„ê°€ê¸°</a>
    </div>
</div>

<!-- DB êµ¬ì¡° ë¶„ì„ ì„¹ì…˜ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° ë¶„ì„</h5>
            </div>
            <div class="card-body">
                <div id="schema-analysis" class="text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                    </div>
                    LLMì´ DB êµ¬ì¡°ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì¶”ì²œ ì§ˆë¬¸ ì„¹ì…˜ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">ğŸ’¡ ì´ëŸ° ì§ˆë¬¸ì„ í•´ë³¼ ìˆ˜ ìˆì–´ìš”</h5>
            </div>
            <div class="card-body">
                <div id="suggested-queries" class="text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                    </div>
                    ì¶”ì²œ ì§ˆë¬¸ ìƒì„± ì¤‘...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì§ˆì˜ ì…ë ¥ ì„¹ì…˜ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ” ìì—°ì–´ ì§ˆì˜</h5>
            </div>
            <div class="card-body">
                <textarea class="form-control mb-3" id="user-query" rows="3" 
                          placeholder="ì˜ˆ: ì§€ë‚œë‹¬ ë§¤ì¶œ TOP 5 ìƒí’ˆì€?"></textarea>
                <button class="btn btn-primary" id="generate-sql-btn">
                    <span id="generate-btn-text">SQL ìƒì„±í•˜ê¸°</span>
                    <span id="generate-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SQL ìƒì„± ê²°ê³¼ ì„¹ì…˜ -->
<div class="row mb-4" id="sql-result-section" style="display: none;">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">ğŸ’­ AIì˜ ì‚¬ê³  ê³¼ì •</h6>
            </div>
            <div class="card-body">
                <div id="ai-reasoning" style="white-space: pre-wrap;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">ğŸ“ ìƒì„±ëœ SQL</h6>
            </div>
            <div class="card-body">
                <pre id="generated-sql" class="bg-light p-3" style="border-radius: 5px;"></pre>
                <button class="btn btn-success mt-2" id="execute-sql-btn">
                    <span id="execute-btn-text">ì‹¤í–‰í•˜ê¸°</span>
                    <span id="execute-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ê²°ê³¼ í…Œì´ë¸” ì„¹ì…˜ -->
<div class="row" id="result-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">ğŸ“‹ ì¿¼ë¦¬ ê²°ê³¼</h6>
            </div>
            <div class="card-body">
                <div id="query-result" class="table-responsive"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const dbName = "{{ db_name }}";
let currentSQL = "";

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤í‚¤ë§ˆ ë¶„ì„ & ì¶”ì²œ ì§ˆë¬¸ ìë™ ë¡œë“œ
window.addEventListener('DOMContentLoaded', function() {
    loadSchemaAnalysis();
    loadSuggestedQueries();
});

// ìŠ¤í‚¤ë§ˆ ë¶„ì„ ë¡œë“œ
function loadSchemaAnalysis() {
    fetch(`/api/analyze_schema/${dbName}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('schema-analysis').innerHTML = 
                    data.analysis.replace(/\n/g, '<br>');
            } else {
                document.getElementById('schema-analysis').innerHTML = 
                    '<span class="text-danger">ë¶„ì„ ì‹¤íŒ¨</span>';
            }
        })
        .catch(error => {
            document.getElementById('schema-analysis').innerHTML = 
                '<span class="text-danger">ì˜¤ë¥˜ ë°œìƒ: ' + error + '</span>';
        });
}

// ì¶”ì²œ ì§ˆë¬¸ ë¡œë“œ
function loadSuggestedQueries() {
    fetch(`/api/suggest_queries/${dbName}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.queries.length > 0) {
                let html = '<ul class="list-group">';
                data.queries.forEach(query => {
                    html += `<li class="list-group-item list-group-item-action suggested-query" style="cursor: pointer;">
                        ${query}
                    </li>`;
                });
                html += '</ul>';
                document.getElementById('suggested-queries').innerHTML = html;
                
                // í´ë¦­ ì‹œ ì§ˆë¬¸ ì…ë ¥ì°½ì— ìë™ ì…ë ¥
                document.querySelectorAll('.suggested-query').forEach(item => {
                    item.addEventListener('click', function() {
                        document.getElementById('user-query').value = this.textContent.trim();
                    });
                });
            } else {
                document.getElementById('suggested-queries').innerHTML = 
                    '<span class="text-muted">ì¶”ì²œ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
            }
        })
        .catch(error => {
            document.getElementById('suggested-queries').innerHTML = 
                '<span class="text-danger">ì˜¤ë¥˜ ë°œìƒ: ' + error + '</span>';
        });
}

// SQL ìƒì„±
document.getElementById('generate-sql-btn').addEventListener('click', function() {
    const question = document.getElementById('user-query').value.trim();
    
    if (!question) {
        alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ë¡œë”© í‘œì‹œ
    document.getElementById('generate-btn-text').classList.add('d-none');
    document.getElementById('generate-spinner').classList.remove('d-none');
    this.disabled = true;
    
    fetch(`/api/generate_sql/${dbName}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: question })
    })
    .then(response => response.json())
    .then(data => {
        // ë¡œë”© í•´ì œ
        document.getElementById('generate-btn-text').classList.remove('d-none');
        document.getElementById('generate-spinner').classList.add('d-none');
        document.getElementById('generate-sql-btn').disabled = false;
        
        if (data.success) {
            currentSQL = data.sql;
            document.getElementById('ai-reasoning').textContent = data.reasoning;
            document.getElementById('generated-sql').textContent = data.sql;
            document.getElementById('sql-result-section').style.display = 'flex';
            document.getElementById('result-section').style.display = 'none';
        } else {
            alert('SQL ìƒì„± ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        document.getElementById('generate-btn-text').classList.remove('d-none');
        document.getElementById('generate-spinner').classList.add('d-none');
        document.getElementById('generate-sql-btn').disabled = false;
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
    });
});

// SQL ì‹¤í–‰
document.getElementById('execute-sql-btn').addEventListener('click', function() {
    if (!currentSQL) {
        alert('ë¨¼ì € SQLì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ë¡œë”© í‘œì‹œ
    document.getElementById('execute-btn-text').classList.add('d-none');
    document.getElementById('execute-spinner').classList.remove('d-none');
    this.disabled = true;
    
    fetch(`/api/execute_sql/${dbName}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sql: currentSQL })
    })
    .then(response => response.json())
    .then(data => {
        // ë¡œë”© í•´ì œ
        document.getElementById('execute-btn-text').classList.remove('d-none');
        document.getElementById('execute-spinner').classList.add('d-none');
        document.getElementById('execute-sql-btn').disabled = false;
        
        if (data.success) {
            displayResults(data.columns, data.rows);
        } else {
            alert('SQL ì‹¤í–‰ ì‹¤íŒ¨: ' + data.error);
        }
    })
    .catch(error => {
        document.getElementById('execute-btn-text').classList.remove('d-none');
        document.getElementById('execute-spinner').classList.add('d-none');
        document.getElementById('execute-sql-btn').disabled = false;
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
    });
});

// ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§
function displayResults(columns, rows) {
    let html = '<table class="table table-striped table-hover">';
    
    // í—¤ë”
    html += '<thead class="table-dark"><tr>';
    columns.forEach(col => {
        html += `<th>${col}</th>`;
    });
    html += '</tr></thead>';
    
    // ë°ì´í„°
    html += '<tbody>';
    if (rows.length === 0) {
        html += `<tr><td colspan="${columns.length}" class="text-center text-muted">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
    } else {
        rows.forEach(row => {
            html += '<tr>';
            row.forEach(cell => {
                html += `<td>${cell !== null ? cell : '<span class="text-muted">NULL</span>'}</td>`;
            });
            html += '</tr>';
        });
    }
    html += '</tbody></table>';
    
    document.getElementById('query-result').innerHTML = html;
    document.getElementById('result-section').style.display = 'block';
    
    // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
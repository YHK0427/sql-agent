{% extends "base.html" %}

{% block title %}Glass-Box SQL Agent{% endblock %}

{% block content %}
<div class="home-container">
    <!-- í—¤ë” -->
    <header class="home-header">
        <div class="logo">
            <span class="logo-icon">ğŸ”</span>
            <span class="logo-text">Glass-Box SQL Agent</span>
        </div>
        <p class="subtitle">AI ê¸°ë°˜ íˆ¬ëª…í•œ SQL ë¶„ì„ í”Œë«í¼</p>
    </header>

    <!-- DB ì¹´ë“œ ê·¸ë¦¬ë“œ -->
    <div class="db-grid">
        {% for db_key, db_info in databases.items() %}
        <div class="db-card" data-url="{{ url_for('dashboard', db_name=db_key) }}">
            <div class="db-card-header">
                <span class="db-icon">{{ db_info.icon }}</span>
                <button class="delete-btn" data-db="{{ db_key }}">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M2 4h12M5.333 4V2.667a1.333 1.333 0 0 1 1.334-1.334h2.666a1.333 1.333 0 0 1 1.334 1.334V4m2 0v9.333a1.333 1.333 0 0 1-1.334 1.334H4.667a1.333 1.333 0 0 1-1.334-1.334V4h9.334Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <h3 class="db-name">{{ db_info.name }}</h3>
            <p class="db-description">{{ db_info.description }}</p>
            <div class="db-card-footer">
                <span class="open-btn">ëŒ€ì‹œë³´ë“œ ì—´ê¸° â†’</span>
            </div>
        </div>
        {% endfor %}
        
        <!-- ì¶”ê°€ ì¹´ë“œ -->
        <div class="db-card add-card" id="addCardBtn">
            <div class="add-icon">+</div>
            <h3 class="db-name">ìƒˆ ë°ì´í„°ë² ì´ìŠ¤</h3>
            <p class="db-description">ë°ì´í„°ë² ì´ìŠ¤ ì¶”ê°€</p>
        </div>
    </div>
</div>

<!-- ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal" id="addModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ìƒˆ ë°ì´í„°ë² ì´ìŠ¤ ì¶”ê°€</h2>
            <button class="close-btn" id="closeModalBtn">Ã—</button>
        </div>
        <form id="addDbForm">
            <div class="form-group">
                <label>DB Key</label>
                <input type="text" id="db_key" placeholder="ì˜ˆ: sales_2024" required>
                <small>ì˜ë¬¸, ìˆ«ì, _ ë§Œ ì‚¬ìš© ê°€ëŠ¥</small>
            </div>
            <div class="form-group">
                <label>ì´ë¦„</label>
                <input type="text" id="db_name" placeholder="ì˜ˆ: 2024 ë§¤ì¶œ ë°ì´í„°" required>
            </div>
            <div class="form-group">
                <label>ì„¤ëª…</label>
                <textarea id="db_description" rows="2" placeholder="ê°„ë‹¨í•œ ì„¤ëª…"></textarea>
            </div>
            <div class="form-group">
                <label>ì•„ì´ì½˜ (ì´ëª¨ì§€)</label>
                <input type="text" id="db_icon" maxlength="2" placeholder="ğŸ“Š">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="submitBtn">ì¶”ê°€</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// DB ì¹´ë“œ í´ë¦­
document.querySelectorAll('.db-card[data-url]').forEach(card => {
    card.addEventListener('click', function(e) {
        if (!e.target.closest('.delete-btn')) {
            location.href = this.dataset.url;
        }
    });
});

// ì‚­ì œ ë²„íŠ¼
document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const dbName = this.dataset.db;
        if (!confirm(`"${dbName}" ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        
        fetch(`/delete_db/${dbName}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) location.reload();
                else alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
            });
    });
});

// ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
document.getElementById('addCardBtn').addEventListener('click', () => {
    document.getElementById('addModal').classList.add('active');
});

document.getElementById('closeModalBtn').addEventListener('click', () => {
    document.getElementById('addModal').classList.remove('active');
});

document.getElementById('cancelBtn').addEventListener('click', () => {
    document.getElementById('addModal').classList.remove('active');
});

// DB ì¶”ê°€
document.getElementById('submitBtn').addEventListener('click', () => {
    const data = {
        db_key: document.getElementById('db_key').value.trim(),
        db_name: document.getElementById('db_name').value.trim(),
        db_description: document.getElementById('db_description').value.trim(),
        db_icon: document.getElementById('db_icon').value.trim() || 'ğŸ“'
    };
    
    if (!data.db_key || !data.db_name) {
        alert('DB Keyì™€ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    fetch('/add_db', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) location.reload();
        else alert('ì¶”ê°€ ì‹¤íŒ¨: ' + data.message);
    });
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Database Selection{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 text-center mb-5">
        <h1 class="display-4">ë°ì´í„°ë² ì´ìŠ¤ ì„ íƒ</h1>
        <p class="lead text-muted">ë¶„ì„í•˜ê³  ì‹¶ì€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
    </div>
</div>

<div class="row g-4">
    {% for db_key, db_info in databases.items() %}
    <div class="col-md-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body text-center">
                <div class="display-1 mb-3">{{ db_info.icon }}</div>
                <h5 class="card-title">{{ db_info.name }}</h5>
                <p class="card-text text-muted">{{ db_info.description }}</p>
                <a href="{{ url_for('dashboard', db_name=db_key) }}" class="btn btn-primary">
                    ëŒ€ì‹œë³´ë“œ ì—´ê¸°
                </a>
                <button class="btn btn-sm btn-outline-danger mt-2 delete-db-btn" 
                        data-db-name="{{ db_key }}">
                    ğŸ—‘ï¸ ì‚­ì œ
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- DB ì¶”ê°€ ì¹´ë“œ (placeholder) -->
<div class="col-md-4">
        <div class="card h-100 shadow-sm" style="border: 2px dashed #ccc;">
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <div class="display-1 mb-3 text-muted">â•</div>
                <h5 class="card-title text-muted">ìƒˆ ë°ì´í„°ë² ì´ìŠ¤</h5>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addDbModal">
                    ì¶”ê°€í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- DB ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addDbModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ìƒˆ ë°ì´í„°ë² ì´ìŠ¤ ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addDbForm">
                    <div class="mb-3">
                        <label class="form-label">DB Key (ì˜ë¬¸/ìˆ«ì/_ë§Œ ì‚¬ìš©)</label>
                        <input type="text" class="form-control" id="db_key" required placeholder="ì˜ˆ: sales_2024">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">DB ì´ë¦„</label>
                        <input type="text" class="form-control" id="db_name" required placeholder="ì˜ˆ: 2024 ë§¤ì¶œ ë°ì´í„°">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì„¤ëª…</label>
                        <textarea class="form-control" id="db_description" rows="2" placeholder="ì´ DBì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì•„ì´ì½˜ (ì´ëª¨ì§€)</label>
                        <input type="text" class="form-control" id="db_icon" maxlength="2" placeholder="ğŸ“Š">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="submitAddDb">ì¶”ê°€</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.delete-db-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        const dbName = this.getAttribute('data-db-name');
        
        if (confirm(`ì •ë§ "${dbName}" ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            fetch(`/delete_db/${dbName}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
            });
        }
    });
});
// DB ì¶”ê°€
document.getElementById('submitAddDb').addEventListener('click', function() {
    const dbKey = document.getElementById('db_key').value.trim();
    const dbName = document.getElementById('db_name').value.trim();
    const dbDescription = document.getElementById('db_description').value.trim();
    const dbIcon = document.getElementById('db_icon').value.trim() || 'ğŸ“';
    
    if (!dbKey || !dbName) {
        alert('DB Keyì™€ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
    }
    
    fetch('/add_db', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            db_key: dbKey,
            db_name: dbName,
            db_description: dbDescription,
            db_icon: dbIcon
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('ì¶”ê°€ ì‹¤íŒ¨: ' + data.message);
        }
    })
    .catch(error => {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
    });
});
</script>
{% endblock %}